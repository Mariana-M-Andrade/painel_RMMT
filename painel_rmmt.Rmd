---
title: "Óbitos Maternos Tardios" 
output: 
  flexdashboard::flex_dashboard:
    logo: www/logo-oobr.png
    favicon: www/logo-oobr-browser.png
    theme:
      version: 4
      navbar-bg: "#0A1E3C"
    orientation: rows
    source_code: embed
    navbar:
        - { icon: "fa-twitter", href: "https://twitter.com/observatorioobr", align: right}
        - { icon: "fa-instagram", href: "https://www.instagram.com/observatorioobr", align: right}
        - { icon: "fa-youtube", href: "https://www.youtube.com/channel/UCp4k0g_6yP-S8G2DU6_lSeQ", align: right }
        - { icon: "fa-envelope", href: "mailto:comunicacao@observatorioobstetricobr.org", align: right }
runtime: shiny   
---

```{=html}
<style>
.navbar.navbar-inverse {
  background-color: #0A1E3C !important;
  border-color: #0A1E3C !important;
}
.navbar-brand {
    color: #ffffff !important;
    font-size: 1.3rem;
    vertical-align: middle;
}
body {
    font-size: 1em;
    background: white;
    padding: 83px 15px 8px;
}
.section.sidebar {
  top: 50px;
  background-color: #eaf2ff;
  color: #000000
}
.negrito {
  font-weight: 700;
}
.chart-title {
    border-bottom: 1px solid #dee2e6;
    font-size: 1.1em;
    font-weight: 600;
    padding: 7px 10px 4px;
}
</style>
```
```{r}
knitr::opts_chunk$set(message = FALSE)
```

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(janitor)
library(shiny)
library(reactable)
library(reactablefmtr)
library(openxlsx)
library(gtsummary)
library(gt)
library(glue)
library(ggplot2)
library(dplyr)
library(geobr)

# Carregando os arquivos necessÃ¡rios
df_mt_desc <- read_delim("df_mt_desc_tardia.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE) |>
  clean_names()

obitos_mt_ofc <- read_delim("obitos_mt_ofc_tardia.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE) |>
  clean_names()

sinasc <- read_csv("sinasc.csv")

sinasc_br <- read_delim("sinasc.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE) |>
  clean_names()

tabela_aux_municipios <- read_delim("tabela_auxiliar_municipios.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE) 

estadosChoices <- sort(unique(tabela_aux_municipios$uf))


br_uf <- read_state(year = 2020, simplified = TRUE)

# Definindo as configuraÃ§Ãµes globais das tabelas
options(reactable.theme = reactableTheme(
  borderColor = "#dfe2e5",
  stripedColor = "#e5efff",
  highlightColor = "#CDDEFC",
  cellPadding = "8px 12px",
  searchInputStyle = list(width = "100%")
))

# Obtendo o dia, mÃªs e ano por extenso
df_meses <- data.frame(
  num_mes = 1:12,
  nome_mes = c("janeiro", "fevereiro", "marÃ§o", "abril", "maio", "junho", "julho",
               "agosto", "setembro", "outubro", "novembro", "dezembro")
)

data <- Sys.Date()
data_por_extenso <- glue(
  "{substr(data, 9, 10)} de {df_meses$nome_mes[which(df_meses$num_mes == as.numeric(substr(data, start = 6, stop = 7)))]} de {substr(data, 1, 4)}"
)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
#MMT
df_mt_desc <- df_mt_desc %>%
  filter(ano >= 2015 & ano<= 2022) %>%
  filter(capitulo_cid10 != "XX - Causas externas de morbidade e de mortalidade")%>%
  filter(idade >= 10 & idade <= 49) %>%
  mutate(categoria = str_sub(causabas_categoria, end = 3))



#Óbitos oficiais
obitos_mt_ofc <- obitos_mt_ofc %>%
  filter(ano >= 2015 & ano<= 2022) %>%
  filter(idade >= 10 & idade <= 49) %>%
  mutate(categoria = str_sub(causabas_categoria, end = 3))

#Nasciso vivos

#Selecionando as variáveis necessárias
sinasc <- sinasc %>%
  select(uf, ano, nascidos)

#Filtrando a base Sinasc
sinasc_br <- sinasc_br %>%
  filter(localidade_nome == "Brasil") %>%
  select(ano, localidade_nome, nascidos)

#Mudando o tipo da variável
sinasc_br$ano <- as.character(sinasc_br$ano)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

#Juntando as bases de Óbitos desconsiderados e Óbitos oficiais
all_obitos <- bind_rows(df_mt_desc, obitos_mt_ofc)


#Mudando o tipo da variável
all_obitos$ano <- as.character(all_obitos$ano)
sinasc$ano <- as.character(sinasc$ano)

# Agrupando por ano e uf, e somando os obitos
all_obitos <- all_obitos %>%
  group_by(ano, uf, regiao, idade, racacor, categoria) %>%
  summarise(obitos = sum(obitos, na.rm = TRUE), .groups = 'drop')

#Juntando as bases de Óbitos e nascidos vivos
obit_nasc <- left_join(all_obitos, sinasc, by = c("ano", "uf"))

#Tirando NA da base
obit_nasc <- obit_nasc %>%
  filter(!is.na(uf))

```


# Sobre

<h3>[Morte Materna Tardia]{style="font-weight: bold;"}</h3>

Éconsiderado uma morte materna tardia o Óbito materno que ocorre no período do puerpério tardio, em outras palavras, entre 43 dias a 1 ano após o parto. Os Óbitos maternos tardios não são considerados no cálculo da Razão de Mortalidade Materna, taxa conhecida como RMM.

<h3>[Razão de Mortalidade Materna Tardia]{style="font-weight: bold;"}</h3>

Visto que o cálculo da RMM não inclui mortes maternas ocorridas no puerpério tardio, a maneira utilizada para medir a situação é calcular uma nova taxa utilizando apenas Óbitos maternos tardios e seguindo o mesmo modelo de cálculo da RMM.

<h3>[Os dados]{style="font-weight: bold;"}</h3>

O painel conta com dados disponibilizados pelo Ministério da Saúde no DATASUS, utilizando as bases "Sistema de Informação de Mortalidade" (SIM) e "Sistema de Informação de Nascidos Vivos (SINASC), ambas bases públicas.

Para esse estudo em específico as bases foram filtradas, constando dados do período de 2015 a 2022.

Os dados utilizados neste painel podem ser acessados em: Herzog, R. S.; Francisco, R. P. V.; Rodrigues, A. S. Óbitos de gestantes e puérperas [banco de dados], 2022, Observatório Obstétrico Brasileiro (OOBr). Disponível em DOI: <https://doi.org/10.7303/syn42902915>.

<h3>[Realização]{style="font-weight: bold;"}</h3>

<center>

```{r, out.width="10%", fig.show='hold'}
knitr::include_graphics(c(
  "www/logos/realizacao/logo_oobr.png",
  "www/logos/realizacao/logo_ufes.png",
  "www/logos/realizacao/logo_medicina_usp.png", 
  "www/logos/realizacao/logo_daslab.png"
))
```

</center>

<h3>[Financiadores]{style="font-weight: bold;"}</h3>

<center>

```{r, teste, out.width="10%", fig.show='hold'}
knitr::include_graphics(c(
  "www/logos/financiadores/logo_bill_melinda.png",
  "www/logos/financiadores/logo_cnpq.png",
  "www/logos/financiadores/logo_ms1.png", 
  "www/logos/financiadores/logo_ms2.png", 
  "www/logos/financiadores/logo_ms3.png", 
  "www/logos/financiadores/logo_fapes.png",
  "www/logos/financiadores/logo_fapes2.png"
))
```

</center>

# Óbitos maternos tardios {data-navmenu="Visualizações"}

## Inputs {.sidebar data-width="350" style="width: 350px; visibility: visible; top: 75px;"}

```{r input-obitosM}
hr();h5(span("Óbitos maternos tardios", style = "font-weight: bold;")); hr()

span("Temporalidade e localidade", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

numericInput(
  inputId = "selectAnoOM",
  label = HTML("<span class = 'negrito'> Selecione o ano de análise: </span>"),
  value = max(all_obitos$ano),
  min = min(all_obitos$ano),
  max = max(all_obitos$ano)
)

selectInput(
  inputId = "selectNivelOM",
  label = HTML("<span class = 'negrito'> Selecione o nível de análise: </span>"),
  choices = c("Nacional", "Estadual"),
  selected = "Nacional"
)

conditionalPanel(
  condition = "input.selectNivelOM == 'Nacional'",
  checkboxGroupInput(
    inputId = "selectRegiaoOM",
    label = HTML("<span class = 'negrito'> Selecione as regiões de análise: </span>"),
    choices = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul"),
    selected = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul")
  )
)

conditionalPanel(
  condition = "input.selectNivelOM == 'Estadual'",
  selectInput(
    inputId = "selectEstadoOM",
    label = HTML("<span class = 'negrito'> Selecione o estado: </span>"),
    choices = estadosChoices,
    multiple = FALSE
    )
)




hr()
span("Características da puérpera", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

sliderInput(
  inputId = "selectIdadeOM",
  label = HTML("<span class = 'negrito'> Selecione a faixa etária a ser considerada: </span>"),
  min = 0,
  max = 99,
  value = c(10, 49)
)

checkboxGroupInput(
  inputId = "selectRacaOM",
  label = HTML("<span class = 'negrito'> Selecione a Raça/cor da puérpera: </span>"),
  choices = sort(unique(all_obitos$racacor)),
  selected = sort(unique(all_obitos$racacor))
)

    
selectInput(
  inputId = "selectDownloadOM",
  label = HTML("<span class = 'negrito'> Deseja fazer o download dessa tabela? </span>"),
  choices = c("não", "Sim"),
  selected = "não"
)

conditionalPanel(
  condition = "input.selectDownloadOM == 'Sim'",
  selectInput(
    inputId = "selectArquivoOM",
    label = HTML("<span class = 'negrito'> Selecione o tipo do arquivo: </span>"),
    choices = c("CSV", "XLSX"),
    selected = "CSV"
  ),
  conditionalPanel(
    condition = "input.selectArquivoOM == 'CSV'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivelOM == "Nacional" ~ paste0("obitos_maternos_", janitor::make_clean_names(input$selectNivelOM), input$selectAnoOM, ".csv"),
          input$selectNivelOM == "Estadual" ~ paste0("obitos_maternos_", janitor::make_clean_names(input$selectEstadoOM), input$selectAnoOM, ".csv")
        )
        }),
      content = function(file) {
        write.table(dados_om_filtrados(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  ),
  conditionalPanel(
    condition = "input.selectArquivoOM == 'XLSX'",
    downloadHandler(
      filename = reactive({
        case_when(
          input$selectNivelOM == "Nacional" ~ paste0("obitos_maternos_", janitor::make_clean_names(input$selectNivelOM), input$selectAnoOM, ".xlsx"),
          input$selectNivelOM == "Estadual" ~ paste0("obitos_maternos_", janitor::make_clean_names(input$selectEstadoOM), input$selectAnoOM, ".xlsx")
        )
        }),
      content = function(file) {
        write.xlsx(dados_om_filtrados(), file, sep = ";", row.names = FALSE, fileEncoding = "UTF-8")
      }
    )
  )
)

dados_om_filtrados <- reactive({
  if (input$selectNivelOM == "Nacional") {
    if (length(input$selectRegiaoOM) == 5) {
      all_obitos |>
        filter(ano == input$selectAnoOM,
               racacor %in% input$selectRacaOM,
               idade >= input$selectIdadeOM[1] & idade <= input$selectIdadeOM[2]) |>
        mutate(regiao = "Todas") |>
        group_by(ano, regiao, categoria, racacor) |>
        summarise(obitos = sum(as.numeric(obitos))) |>
        ungroup()
    } else {
      all_obitos |>
        filter(ano == input$selectAnoOM,
               regiao %in% input$selectRegiaoOM,
               racacor %in% input$selectRacaOM,
               idade >= input$selectIdadeOM[1] & idade <= input$selectIdadeOM[2]) |>
        group_by(regiao, ano, categoria,  racacor) |>
        summarise(obitos = sum(as.numeric(obitos))) |>
        ungroup()
    }
  } else if (input$selectNivelOM == "Estadual") {
    all_obitos |>
      filter(ano == input$selectAnoOM,
             uf == unique(tabela_aux_municipios$sigla_uf[which(tabela_aux_municipios$uf == input$selectEstadoOM)]),
             racacor %in% input$selectRacaOM,
             idade >= input$selectIdadeOM[1] & idade <= input$selectIdadeOM[2]) |>
      group_by(uf, regiao, ano, categoria, racacor) |>
      summarise(obitos = sum(as.numeric(obitos))) |>
      ungroup() 
  }
})


```

------------------------------------------------------------------------



## Row

### [Tabela de Óbitos maternos tardios]{style="font-weight: 700; color: black"}

```{r tabela_om}
dados_tabela_om <- reactive({
  if (input$selectNivelOM == "Nacional") {
    dados_om_filtrados() |>
      select(!c(ano, regiao))
  } else if (input$selectNivelOM == "Estadual") {
    dados_om_filtrados() |>
      select(!c(uf, regiao, ano))
  }
})


renderReactable({
  validate(
    need(nrow(dados_tabela_om()) != 0, message = "Não existem registros de Óbitos maternos para os filtros selecionados.")
  )
  if (nrow(dados_tabela_om()) > 0) {
    dados_tabela_om() |>
      reactable(
        groupBy = c("categoria"),
        columns = list(
          categoria = colDef(
            name = "Categoria CID10",
            aggregate = "count",
            format = list(aggregated = colFormat(suffix = " ocorrência(s)"))
          ),
          obitos = colDef(
            name = "Nº de Óbitos",
            aggregate = "sum",
            footer = JS(
              "function(colInfo) {
                        let obitosTotais = 0
                        colInfo.data.forEach(function(row) {
                          obitosTotais += row['obitos']
                        })
                        return obitosTotais
                        }"
            )
          ),
          racacor = colDef(
            name = "Raça/Cor",
            aggregate = JS("function() { return ''}"),
            format = list(aggregated = colFormat(prefix = "Todas"))
          )
        ),
        defaultSorted = c("categoria"),
        searchable = TRUE,
        sortable = TRUE,
        resizable = TRUE,
        filterable = TRUE,
        highlight = TRUE,
        striped = TRUE,
        bordered = FALSE,
        pagination = FALSE,
        defaultColDef = colDef(footerStyle = list(fontWeight = "bold")),
        rowStyle = JS(
          "function(rowInfo) {
          if (rowInfo.aggregated === true) {
           return { fontWeight: 700 }
          }
        }"
        )
      )
  }
})
```

# Mapa {data-navmenu="Visualizações"}

## Inputs {.sidebar data-width="350" style="width: 350px; visibility: visible; top: 75px;"}

```{r input-RMMT}
hr();h5(span("Óbitos maternos tardios", style = "font-weight: bold;")); hr()

span("Temporalidade e localidade", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

numericInput(
  inputId = "selectAnoOM",
  label = HTML("<span class = 'negrito'> Selecione o ano de análise: </span>"),
  value = max(obit_nasc$ano),
  min = min(obit_nasc$ano),
  max = max(obit_nasc$ano)
)

hr()
span("Características da puérpera", style = "font-weight: bold; font-size: 17px")
HTML("<span style='display: block; margin-bottom: 7px;'> </span>")

sliderInput(
  inputId = "selectIdadeOM",
  label = HTML("<span class = 'negrito'> Selecione a faixa etária a ser considerada: </span>"),
  min = 0,
  max = 99,
  value = c(10, 49)
)

checkboxGroupInput(
  inputId = "selectRacaOM",
  label = HTML("<span class = 'negrito'> Selecione a Raça/cor da puérpera: </span>"),
  choices = sort(unique(obit_nasc$racacor)),
  selected = sort(unique(obit_nasc$racacor))
)

selectInput(
  inputId = "selectDownloadOM",
  label = HTML("<span class = 'negrito'> Deseja fazer o download dessa tabela? </span>"),
  choices = c("não", "Sim"),
  selected = "não"
)

dados_rmmt_filtrados <- reactive({
  obit_nasc |>
    filter(ano == input$selectAnoOM,
           racacor %in% input$selectRacaOM,
           idade >= input$selectIdadeOM[1] & idade <= input$selectIdadeOM[2]) |>
    group_by(uf) |>
    summarise(
      obitos = sum(as.numeric(obitos), na.rm = TRUE),
      nascidos = sum(as.numeric(nascidos), na.rm = TRUE)
    ) |>
    mutate(rmm = round((obitos / nascidos) * 100000, 2)) |>
    ungroup()
})


```

## Row

### [Mapa da Razão de Mortalidade Materna Tardia]{style="font-weight: 700; color: black"}

```{r mapaRMMT}
renderPlot({
    # Validando se os dados estão disponíveis
    validate(
      need(nrow(dados_rmmt_filtrados()) > 0, "não existem registros suficientes para gerar o mapa.")
    )
    
    # Juntando os dados de RMM com os dados geogrÃ¡ficos das UFs
    br_uf1 <- reactive(left_join(br_uf, dados_rmmt_filtrados(), by = c("abbrev_state" = "uf")))

    # Plotando o mapa
    ggplot(data = br_uf1()) +
      geom_sf(aes(fill = rmm), color = "white") +
      scale_fill_gradient(low = "lightgreen", high = "purple", na.value = "grey50", name = "RMM Tardia") +
      theme_minimal() +
      theme(legend.position = "right")
  })

```